<!-- Plotly example 1
Yosuke Tanigawa
2017/11/14
The description is in README.md
-->

<head>
    
    <!-- Plotly.js -->
    <title>HLA Haplotypes</title>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/0.8.3/jquery.csv.js"></script>
    <script type="text/javascript" src="https://d3js.org/d3.v3.min.js"></script>
    
    <script type="text/javascript" src="https://cdn.plot.ly/plotly-latest.min.js"></script> 
    
    <script>        
        var genes = ["A", "B", "C","DPA1","DPB1","DQA1","DQB1","DRB1","DRB3","DRB4","DRB5"];

        function plotly_from_csv_callback(csv_string, plotDivName, label_col_idx, gene, phe_dict, disease_dict, hla_name_dict){
            var csv_array_of_cols=$.csv.toArrays(csv_string);
            var labels = csv_array_of_cols[label_col_idx];
            len_x = labels.length;
            //console.log(hla_name_dict);
            
            for (var i = 0; i < labels.length; i++) {
              labels[i] = hla_name_dict[labels[i]];
            }
            
            //var x = csv_array_of_cols[label_col_idx];
            var x = d3.range(1, 1 + labels.length);
            var data = [];
            var trace;
            for (var i = 1; i < csv_array_of_cols["length"]; i++) {
              var x_noise = x.slice(0,len_x);
              for (var j = 0; j < x_noise.length; j++) {
                var sign = Math.random();
                if (sign < 0.5) {
                  sign = -1;
                } else {
                  sign = 1;
                }
                // jitter by 0.25 (leave space between columns)
                x_noise[j] = x_noise[j] + sign*Math.random()*0.25;
                //labels.push(labels[j]);
                //x.push(x_noise[j]);
              }
              var y = csv_array_of_cols[i];
              y = y.slice(1,);
              y.unshift("");
              //console.log(phe_dict[csv_array_of_cols[i][0]]);
              var new_text = [];
              for (var k = 0; k < x.length; k++) {
                new_text.push("post prob: " + y[k] + "<br>" + "hap: " + labels[k] + "<br>" + "pheno: " + phe_dict[csv_array_of_cols[i][0]]);
              }
              trace = {
                'x': x_noise, 'y': y, 
                type: 'scattergl', 'mode': 'markers',
                name: phe_dict[csv_array_of_cols[i][0]],
                xaxis: "x",
                //text: labels + "\n" + phe_dict[csv_array_of_cols[i][0]],
                //text: phe_dict[csv_array_of_cols[i][0]],
                /*
                text: {
                  "post prob: ": y

                }
                */
                text: new_text,
                hoverinfo: "text"
              }
              data.push(trace);
            }
            /*
            trace = {
              'x': [1], 'y': [1], type: 'scattergl', 'mode': 'markers', xaxis: "x2"
            }
            data.push(trace);
            */

            var layout = {
                hovermode:'closest',
                //hovermode: "y",
                //hoverinfo: "text+y",
                //hoverinfo: "none",
                hoverinfo: "text",
                showlegend: false,
                title: "Posterior probabilities of top 10 HLA-" + gene + " alleles for " + csv_array_of_cols["length"] + " phenotypes",
            		xaxis: {
            		  tickangle: 45,
                  showticklabels: true,
                  tickmode: "array",
                  ticks: "", 
                  ticktext: labels.slice(0,len_x),
                  tickvals: x.slice(0,len_x),
                  //showticklabels: false
                  //autotick: true
                  //tickvals: [i * step for i in range(len(labels))]
            		},
                /*
                xaxis2: {
                  tickangle: 45,
                  showticklabels: true,
                  tickmode: "array",
                  ticks: "", 
                  ticktext: labels.slice(1,len_x),
                  tickvals: x.slice(1,len_x),
                  overlaying: 'x',
                  //anchor: 'free'
                  //autotick: true
                  //tickvals: [i * step for i in range(len(labels))]
                },
                */
                
                
                yaxis: {
                  title: "posterior probability",
                  range: [-0.1,1.1]
                }
            };

            Plotly.newPlot(plotDivName, data, layout); 
            myPlot = document.getElementById(plotDivName); 
            
            // Go to GBE page for given phenotype on click
            myPlot.on('plotly_click', function(data){
              console.log(data);
              window.open("https://biobankengine.stanford.edu/coding/" + disease_dict[data.points[0].data.name]);
            });
              

        } 
        
        function plotly_from_csv(csv_file, plotDivName, label_col_idx, gene, phe_dict, disease_dict, hla_name_dict) {
            //console.log("here" + gene);

            $.ajax({
                url: csv_file,
                dataType: 'text',
            }).done(
                text => plotly_from_csv_callback(
                    text, plotDivName, label_col_idx, gene, phe_dict, disease_dict, hla_name_dict
                )
            );
        }
      var phe_dict = {};
      var disease_dict = {};
      d3.csv("highconfidenceqc_map.csv", function(data) {
        for (var i = 0; i < data.length; i++) {
          phe_dict[data[i].code] = data[i].disease;
          disease_dict[data[i].disease] = [data[i].code];
        }
      });
      var hla_name_dict = {};
      d3.csv("ukb_to_asterisk_names.csv", function(data){
        for (var i = 0; i < data.length; i++) {
          hla_name_dict[data[i].ukb_names] = data[i].literature_names;
        }
      });
        $(document).ready(function () {
	    
          plotly_from_csv('phe_hap/phe_post_table_' + genes[0] + '.csv', 'plotly_div',  0, genes[0], phe_dict, disease_dict, hla_name_dict);
	    
        });
  
    </script>

</head>

<body>
  <h1>Posterior Probabilities for HLA Alleles</h1>
  <div id='plots'></div>
  <script> 
    var container = document.getElementById("plots");
    container.innerHTML += '<div id="plotly_div"></div>';

</script>
  <h2>Class I</h2>
  <div id='buttons_1'></div>
  <h2>Class II</h2>
  <div id='buttons_2'></div>
  
  <script>
    var class_1 = genes.slice(0,3);
    var button;
    for (i=0; i<class_1.length; i++) {
    button = document.createElement('button');
    button.innerHTML = "HLA-" + class_1[i];
    button.id = class_1[i];
    button.addEventListener('click', function() {
      plotly_from_csv('phe_hap/phe_post_table_' + this.id + '.csv', 'plotly_div',  0, this.id, phe_dict, disease_dict, hla_name_dict);
    });
    document.getElementById('buttons_1').appendChild(button);
}
    </script>
 
     <script>
    var class_2 = genes.slice(4,);
    var button;
    for (i=0; i<class_2.length; i++) {
    button = document.createElement('button');
    button.innerHTML = "HLA-" + class_2[i];
    button.id = class_2[i];
    button.addEventListener('click', function() {
      plotly_from_csv('phe_hap/phe_post_table_' + this.id + '.csv', 'plotly_div',  0, this.id, phe_dict, disease_dict, hla_name_dict);
    });
    document.getElementById('buttons_2').appendChild(button);
}
    </script>
</body>

